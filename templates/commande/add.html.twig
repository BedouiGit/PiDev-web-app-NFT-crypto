{% extends 'basefront.html.twig' %}

{% block title %}Add{% endblock %}


{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.0"></script>


{{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'nftForm'}}) }}
    <div class="create-area rn-section-gapTop">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-3 offset-1 ml_md--0 ml_sm--0">
                    <!-- file upload area -->
                    <div class="upload-area">

                        <div class="upload-formate mb--30">
                            <h6 class="title">
                                Acquire a new NFT
                            </h6>
                        </div>

                        <img src="{{ asset(nft.image) }}" style="max-width: 150px;">

                    </div>

                    <div class="mt--100 mt_sm--30 mt_md--30 d-none d-lg-block">
                        <h5> Note: </h5>
                        <span> Service fee : <strong>2.5%</strong> </span> <br>
                    </div>

                </div>

                <div class="col-lg-7">
                    <div class="form-wrapper-one">
                        <form class="row" action="#">

                            <div class="col-md-12">
                                <div class="input-box pb--20">
                                    {{ form_row(form.Wallet) }}
                                </div>
                            </div>

                            <div class="col-md-12">
                                <div class="input-box pb--20">
                                    {{ form_row(form.email) }}
                                </div>
                            </div>
                            <div class="col-md-12">
                               price :  {{nft.price}}
                            </div>

                            <div style=" height: 20px;"></div>


                                    <button id="buyButton" class="btn btn-primary btn-user btn-block">{{ button_label|default('Buy') }}</button>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const ethereum = window.ethereum;
    const walletAddressInput = document.getElementById('walletAddress'); // Ensure this ID matches your form input ID

    if (!ethereum || !ethereum.isMetaMask) {
        console.log('MetaMask is not installed!');
        return;
    }

    // Check if user has already granted access
    let accounts = await ethereum.request({ method: 'eth_accounts' });

    if (accounts.length > 0) {
        // User has already connected MetaMask, fill the wallet address
        walletAddressInput.value = accounts[0];
    } else {
        console.log('MetaMask is locked or the user has not connected any accounts');
        // Optionally, prompt the user to connect their MetaMask wallet
        // This requires a user action, such as clicking a "Connect Wallet" button
    }
});

const buyButton = document.getElementById('buyButton');
const form = document.getElementById('nftForm');
const ethereum = window.ethereum;
const walletAddressInput = document.getElementById('walletAddress'); // Ensure this ID matches your form input ID

const nftPriceInEther = {{ nft.price }}; // Assuming this is how you get the NFT price
const nftPriceInWei = (nftPriceInEther * 1e18).toString();
const valueInHex = '0x' + BigInt(nftPriceInWei).toString(16);

const sendTransaction = async (event) => {
    event.preventDefault(); // Prevent the form from submitting

    // Ensure MetaMask is installed
    if (!ethereum || !ethereum.isMetaMask) {
        alert('Please install MetaMask.');
        return;
    }

    try {
        // Request account access if needed
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });

        // Set the first account as the wallet address in the form
        walletAddressInput.value = accounts[0];

        // Transaction parameters
        const transactionParameters = {
            nonce: '0x00', // Ignored by MetaMask
            to: '0x6ac436930Bda6bf231E10C4EEb5f2cADE5f06a43', // Replace with your wallet address
            from: ethereum.selectedAddress,
            value: valueInHex,
        };

        // Initiate the transaction
        const txHash = await ethereum.request({
            method: 'eth_sendTransaction',
            params: [transactionParameters],
        });

        console.log('Transaction hash:', txHash);
        alert('Transaction sent! Hash: ' + txHash);

        // If the transaction is successful, you might want to submit the form
        // or handle the confirmation in another way
        // form.submit();
    } catch (error) {
        console.error(error);
        alert('An error occurred, please try again.');
    }
};

buyButton.addEventListener('click', sendTransaction);
</script>


                        </form>
                    </div>

                </div>

                <div class="mt--100 mt_sm--30 mt_md--30 d-block d-lg-none">
                    <h5> Note: </h5>
                    <span> Service fee : <strong>2.5%</strong> </span> <br>
                    <span> You will receive : <strong>25.00 ETH $50,000</strong></span>
                </div>
            </div>
        </div>
    </div>

{{ form_end(form) }}

{% endblock %}